#!/bin/bash

MSG_FILE="$1"
COMMIT_TYPE="$2"

PROMPT=$(
    cat << EOF
Write a Git commit message.

The first line should be no more than about 50 characters, and does
not need to be a complete sentence. It does not end in a period.

If additional explanation is warranted, explain in complete sentences
and paragraphs, using bullet points as appropriate.

If specific bugs are mentioned, be sure to include references to them.

Focus on why things are changing instead of only what is being changed.

Be very concise.
EOF
)

if [ -z "$COMMIT_TYPE" ] || [ "$COMMIT_TYPE" = "message" ] || [ "$COMMIT_TYPE" = "template" ]; then
    # Check if file contains any non-blank, non-comment lines
    if ! grep -v '^#' "$MSG_FILE" | grep -q '[^[:space:]]'; then
        echo -e "\n# ✨ Generated draft commit message ✨" >> "$MSG_FILE"
        git diff --cached | llm -s "$PROMPT" | fmt -w 72 >> "$MSG_FILE"
    fi
fi
